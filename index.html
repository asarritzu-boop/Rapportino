<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapporto Servizio PWA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#22c55e">
    <link rel="apple-touch-icon" href="rapporti.png">
    <style>
        :root { 
            --bg: #f8fafc; 
            --success: #22c55e; 
            --antonello-bg: #e0f2fe; 
            --giusi-bg: #f3e8ff; 
            --antonello-accent: #0ea5e9;
            --giusi-accent: #a855f7;
            --text-main: #1e293b;
            --transition: 0.4s ease;
        }
        
        body { 
            font-family: system-ui, sans-serif; 
            background-color: var(--antonello-bg);
            margin: 0; padding: 10px; 
            display: flex; justify-content: center;
            transition: background-color var(--transition);
        }

        .app-container { width: 100%; max-width: 450px; }
        
        .card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(5px);
            padding: 15px; border-radius: 16px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            margin-bottom: 12px; 
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f1f5f9;
            margin-bottom: 10px;
            padding-bottom: 5px;
        }

        h2 { margin: 0; color: var(--text-main); font-size: 0.9rem; text-transform: uppercase; }
        
        .btn-riepilogo {
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 800;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat { padding: 12px; border-radius: 12px; text-align: center; border: 1px solid rgba(0,0,0,0.05); }
        .stat-ant { background: #bae6fd; }
        .stat-giu { background: #e9d5ff; }
        
        .val-annuale { font-size: 1.8rem; font-weight: 900; color: var(--text-main); line-height: 1; margin-bottom: 5px; }
        
        .box-mese { 
            background: white; 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 12px; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .mese-label { font-size: 0.8rem; font-weight: bold; color: #64748b; display: block; }
        .mese-totale { font-size: 1.6rem; font-weight: 800; color: #000; }
        
        .dettaglio-container { 
            display: flex; 
            justify-content: space-around; 
            margin-top: 5px; 
            font-weight: 800;
            font-size: 0.9rem;
        }
        .det-eff { color: #0284c7; }
        .det-abb { color: #4b5563; }

        .gap-container { 
            margin-top: 10px; 
            padding-top: 10px;
            border-top: 1px dashed rgba(0,0,0,0.1);
            text-align: left;
        }
        .gap-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-gap {
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 800;
        }
        .positivo { background: #dcfce7; color: #166534; }
        .negativo { background: #fee2e2; color: #991b1b; }
        
        label { display: block; margin: 12px 0 4px; font-weight: 700; font-size: 0.85rem; color: #475569; }
        select, input { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-size: 1rem; background: white; outline: none; }
        
        #utente.sel-ant { border-color: var(--antonello-accent); background-color: #f0f9ff; }
        #utente.sel-giu { border-color: var(--giusi-accent); background-color: #faf5ff; }

        .btn-save { width: 100%; background: var(--success); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 1.1rem; font-weight: 900; margin-top: 20px; cursor: pointer; box-shadow: 0 4px 0 #16a34a; }
        .btn-save:active { transform: translateY(2px); box-shadow: 0 2px 0 #16a34a; }
        
        .history-item { padding: 12px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .history-actions { display: flex; gap: 10px; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 5px; border-radius: 5px; transition: background 0.2s; }
        .btn-icon:hover { background: #f1f5f9; }
        
        .btn-action { width: 100%; background: white; border: 1px solid #cbd5e1; padding: 12px; border-radius: 10px; font-size: 0.8rem; margin-top: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-reset { color: #dc2626; border-color: #fecaca; background: #fff1f2; margin-top: 24px; border-width: 2px; }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .table-riepilogo { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .table-riepilogo th, .table-riepilogo td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="card" style="border-top: 6px solid var(--success);">
        <div class="header-container">
            <h2 style="color: var(--success);">Obiettivo Annuale 600h</h2>
            <button id="btnRiepilogo" class="btn-riepilogo" onclick="apriRiepilogo()">Riepilogo</button>
        </div>
        
        <div class="grid">
            <div class="stat stat-ant">
                <label>ANTONELLO</label>
                <div class="val-annuale" id="oreA">0h</div>
                <div class="box-mese">
                    <span class="mese-label">QUESTO MESE</span>
                    <div class="mese-totale" id="meseA">0h</div>
                    <div class="dettaglio-container">
                        <span class="det-eff">Eff: <span id="effA">0</span></span>
                        <span class="det-abb">Abb: <span id="abbA">0</span></span>
                    </div>
                </div>
                <div class="gap-container">
                    <div class="gap-row"><span>GAP 600h:</span><span id="gap600A" class="badge-gap">0</span></div>
                    <div class="gap-row"><span>Media 50h:</span><span id="gapMediaA" class="badge-gap">0</span></div>
                </div>
            </div>

            <div class="stat stat-giu">
                <label>GIUSI</label>
                <div class="val-annuale" id="oreG">0h</div>
                <div class="box-mese">
                    <span class="mese-label">QUESTO MESE</span>
                    <div class="mese-totale" id="meseG">0h</div>
                    <div class="dettaglio-container">
                        <span class="det-eff">Eff: <span id="effG">0</span></span>
                        <span class="det-abb">Abb: <span id="abbG">0</span></span>
                    </div>
                </div>
                <div class="gap-container">
                    <div class="gap-row"><span>GAP 600h:</span><span id="gap600G" class="badge-gap">0</span></div>
                    <div class="gap-row"><span>Media 50h:</span><span id="gapMediaG" class="badge-gap">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 id="formTitle">Nuovo Inserimento</h2>
        <label>Mese di riferimento</label>
        <select id="mese" onchange="calcola()">
            <option value="9">Settembre</option><option value="10">Ottobre</option>
            <option value="11">Novembre</option><option value="12">Dicembre</option>
            <option value="1">Gennaio</option><option value="2">Febbraio</option>
            <option value="3">Marzo</option><option value="4">Aprile</option>
            <option value="5">Maggio</option><option value="6">Giugno</option>
            <option value="7">Luglio</option><option value="8">Agosto</option>
        </select>
        
        <label>Persona</label>
        <select id="utente" onchange="cambiaColoreUtente()">
            <option value="Antonello">Antonello</option>
            <option value="Giusi">Giusi</option>
        </select>

        <div class="grid">
            <div><label>Ore Effettive</label><input type="number" id="ore" placeholder="0" inputmode="numeric"></div>
            <div><label>Abbuoni</label><input type="number" id="abbuoni" placeholder="0" inputmode="numeric"></div>
        </div>

        <button class="btn-save" id="btnSalva" onclick="aggiungiDati()">Salva Rapporto</button>
        <button id="btnAnnullaModifica" class="btn-action" style="display:none; color: gray;" onclick="resetForm()">Annulla Modifica</button>
    </div>

    <div class="card">
        <h2 id="titoloGestione">Gestione Dati</h2>
        <div id="listaStorico"></div>
        <button class="btn-action" onclick="esportaDati()">üíæ Esporta Backup</button>
        <button class="btn-action" onclick="document.getElementById('importFile').click()">üìÇ Importa Backup</button>
        <button class="btn-action btn-reset" onclick="resetAnno()">üî• RESET NUOVO ANNO</button>
        <input type="file" id="importFile" style="display:none" onchange="importaDati(event)">
    </div>
</div>

<div id="modalRiepilogo" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="titoloRiepilogo" style="margin-bottom: 15px; border-bottom: 2px solid var(--success);">Riepilogo</h2>
        <div id="corpoRiepilogo"></div>
        <button class="btn-action" onclick="document.getElementById('modalRiepilogo').style.display='none'" style="margin-top:20px">Chiudi</button>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('rapporto_v7')) || [];
    let editIndex = -1;
    const nomiMesi = {9:"Settembre", 10:"Ottobre", 11:"Novembre", 12:"Dicembre", 1:"Gennaio", 2:"Febbraio", 3:"Marzo", 4:"Aprile", 5:"Maggio", 6:"Giugno", 7:"Luglio", 8:"Agosto"};

    function cambiaColoreUtente() {
        const utenteSelect = document.getElementById('utente');
        const btnRiepilogo = document.getElementById('btnRiepilogo');
        const utente = utenteSelect.value;
        if (utente === "Antonello") {
            document.body.style.backgroundColor = "var(--antonello-bg)";
            utenteSelect.className = "sel-ant";
            btnRiepilogo.style.backgroundColor = "var(--antonello-accent)";
            btnRiepilogo.style.color = "white";
        } else {
            document.body.style.backgroundColor = "var(--giusi-bg)";
            utenteSelect.className = "sel-giu";
            btnRiepilogo.style.backgroundColor = "var(--giusi-accent)";
            btnRiepilogo.style.color = "white";
        }
        // Aggiorniamo la lista storico ogni volta che cambia l'utente
        aggiornaLista();
    }

    function calcola() {
        const mesiServizio = [9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8];
        const meseSelezionato = document.getElementById('mese').value;
        const meseOggi = new Date().getMonth() + 1;
        let mesiTrascorsi = mesiServizio.indexOf(meseOggi) + 1 || 12;

        ["Antonello", "Giusi"].forEach(user => {
            let totaleAnnuale = 0;
            let effMeseSelezionato = 0;
            let abbMeseSelezionato = 0;
            let totaleMeseSelezionato = 0;

            mesiServizio.forEach(m => {
                let oreEffMese = db.filter(v => v.utente === user && v.mese == m).reduce((s,v) => s + v.ore, 0);
                let abbDisponibili = db.filter(v => v.utente === user && v.mese == m).reduce((s,v) => s + v.abbuoni, 0);
                let abbUsati = (oreEffMese < 55) ? Math.min(abbDisponibili, 55 - oreEffMese) : 0;
                let totaleMese = oreEffMese + abbUsati;
                totaleAnnuale += totaleMese;

                if (m == meseSelezionato) {
                    effMeseSelezionato = oreEffMese;
                    abbMeseSelezionato = abbUsati;
                    totaleMeseSelezionato = totaleMese;
                }
            });

            const s = user === "Antonello" ? "A" : "G";
            document.getElementById('ore'+s).innerText = totaleAnnuale + "h";
            document.getElementById('mese'+s).innerText = totaleMeseSelezionato + "h";
            document.getElementById('eff'+s).innerText = effMeseSelezionato;
            document.getElementById('abb'+s).innerText = abbMeseSelezionato;

            const g600 = totaleAnnuale - 600;
            const gMed = totaleAnnuale - (mesiTrascorsi * 50);

            const updateGap = (id, val) => {
                const el = document.getElementById(id);
                el.innerText = (val > 0 ? "‚Üë +" : "") + val;
                el.className = "badge-gap " + (val >= 0 ? "positivo" : "negativo");
            };
            updateGap('gap600'+s, g600);
            updateGap('gapMedia'+s, gMed);
        });
        aggiornaLista();
    }

    function aggiornaLista() {
        const m = document.getElementById('mese').value;
        const utenteCorrente = document.getElementById('utente').value;
        const lista = document.getElementById('listaStorico');
        const titoloGestione = document.getElementById('titoloGestione');

        titoloGestione.innerText = "Gestione Dati: " + utenteCorrente;
        
        // Filtriamo i dati sia per MESE che per UTENTE SELEZIONATO
        const datiConIndice = db.map((v, i) => ({...v, originalIndex: i}))
                                .filter(v => v.mese == m && v.utente == utenteCorrente);
        
        lista.innerHTML = datiConIndice.length ? datiConIndice.reverse().map(v => `
            <div class="history-item" style="border-left:5px solid ${v.utente === 'Antonello' ? 'var(--antonello-accent)' : 'var(--giusi-accent)'}">
                <span><b>${v.utente}</b><br><small>${v.timestamp}</small></span>
                <span style="text-align:right; flex-grow:1; margin-right:15px"><b>${v.ore}h</b><br><small>Abb: ${v.abbuoni}</small></span>
                <div class="history-actions">
                    <button class="btn-icon" onclick="preparaModifica(${v.originalIndex})">‚úèÔ∏è</button>
                    <button class="btn-icon" onclick="eliminaSingolo(${v.originalIndex})">üóëÔ∏è</button>
                </div>
            </div>`).join('') : `<p style='text-align:center; color:gray; font-size:0.8rem;'>Nessun dato per ${utenteCorrente} questo mese.</p>`;
    }

    function aggiungiDati() {
        const user = document.getElementById('utente').value;
        const m = document.getElementById('mese').value;
        const oIns = parseFloat(document.getElementById('ore').value || 0);
        const aIns = parseFloat(document.getElementById('abbuoni').value || 0);
        const d = new Date();
        const ts = d.getDate()+"/"+(d.getMonth()+1)+" "+d.getHours()+":"+d.getMinutes().toString().padStart(2,'0');

        if (editIndex > -1) {
            db[editIndex] = { utente: user, mese: m, ore: oIns, abbuoni: aIns, timestamp: ts + " (mod.)" };
        } else {
            db.push({ utente: user, mese: m, ore: oIns, abbuoni: aIns, timestamp: ts });
        }
        
        salvaEAutoCalcola();
        resetForm();
    }

    function preparaModifica(index) {
        const record = db[index];
        editIndex = index;
        document.getElementById('utente').value = record.utente;
        document.getElementById('mese').value = record.mese;
        document.getElementById('ore').value = record.ore;
        document.getElementById('abbuoni').value = record.abbuoni;
        document.getElementById('formTitle').innerText = "Modifica Record";
        document.getElementById('btnSalva').innerText = "Aggiorna Record";
        document.getElementById('btnAnnullaModifica').style.display = "block";
        cambiaColoreUtente();
        window.scrollTo({ top: 150, behavior: 'smooth' });
    }

    function eliminaSingolo(index) {
        if(confirm("Eliminare definitivamente questa voce?")) {
            db.splice(index, 1);
            salvaEAutoCalcola();
            if(editIndex === index) resetForm();
        }
    }

    function salvaEAutoCalcola() {
        localStorage.setItem('rapporto_v7', JSON.stringify(db));
        calcola();
    }

    function resetForm() {
        editIndex = -1;
        document.getElementById('ore').value = ""; 
        document.getElementById('abbuoni').value = ""; 
        document.getElementById('formTitle').innerText = "Nuovo Inserimento";
        document.getElementById('btnSalva').innerText = "Salva Rapporto";
        document.getElementById('btnAnnullaModifica').style.display = "none";
    }

    function apriRiepilogo() {
        const mesiServizio = [9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8];
        const meseOggi = new Date().getMonth() + 1;
        const utenteSelezionato = document.getElementById('utente').value;
        
        document.getElementById('titoloRiepilogo').innerText = "Riepilogo: " + utenteSelezionato;
        document.getElementById('titoloRiepilogo').style.borderColor = utenteSelezionato === "Antonello" ? "var(--antonello-accent)" : "var(--giusi-accent)";

        let html = `<table class="table-riepilogo"><tr><th>Mese</th><th>Eff.</th><th>Abb.</th><th>Tot.</th></tr>`;
        
        mesiServizio.forEach(m => {
            let oreEff = db.filter(v => v.utente === utenteSelezionato && v.mese == m).reduce((s,v) => s + v.ore, 0);
            let abbDisp = db.filter(v => v.utente === utenteSelezionato && v.mese == m).reduce((s,v) => s + v.abbuoni, 0);
            let abbUsati = (oreEff < 55) ? Math.min(abbDisp, 55 - oreEff) : 0;
            let tot = oreEff + abbUsati;
            
            if(tot > 0 || m == meseOggi) {
                html += `<tr><td>${nomiMesi[m]}</td><td>${oreEff}h</td><td>${abbUsati}h</td><td><b>${tot}h</b></td></tr>`;
            }
        });
        
        html += `</table>`;
        document.getElementById('corpoRiepilogo').innerHTML = html;
        document.getElementById('modalRiepilogo').style.display = 'block';
    }

    function resetAnno() {
        if (confirm("‚ö†Ô∏è CANCELLARE TUTTO? Inizierai un nuovo anno.") && confirm("Sei sicuro? Perderai ogni dato.")) {
            db = [];
            salvaEAutoCalcola();
        }
    }

    function esportaDati() {
        const blob = new Blob([JSON.stringify(db)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup_servizio.json'; a.click();
    }

    function importaDati(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            db = JSON.parse(ev.target.result);
            salvaEAutoCalcola();
        };
        reader.readAsText(file);
    }

    window.onload = () => { 
        document.getElementById('mese').value = new Date().getMonth() + 1; 
        cambiaColoreUtente();
        calcola(); 
    };
</script>
</body>
</html>
